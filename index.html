<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Esc√°ner QR</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
      background: transparent;
    }

    .scanner-container {
      max-width: 420px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }

    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    #qr-reader {
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .status {
      text-align: center;
      padding: 12px;
      border-radius: 10px;
      margin-bottom: 12px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .status.waiting { background: #fff3cd; color: #856404; }
    .status.scanning { background: #d1ecf1; color: #0c5460; animation: pulse 2s infinite; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    .btn {
      width: 100%;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(118, 75, 162, 0.4);
    }
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    .btn-secondary:hover:not(:disabled) {
      background: #5a6268;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="scanner-container">
    <h2>Esc√°ner QR</h2>
    <div id="qr-reader"></div>

    <div id="status" class="status waiting">
      Presiona "Iniciar esc√°ner" para comenzar
    </div>

    <button id="start-btn" class="btn btn-primary">Iniciar esc√°ner</button>
    <button id="stop-btn" class="btn btn-secondary" style="display:none;">Detener esc√°ner</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"></script>
  <script>
    const ALLOWED_DOMAIN = "cantosdelhumedal.framer.website";

    let scanner = null;
    let isScanning = false;

    const startBtn = document.getElementById("start-btn");
    const stopBtn = document.getElementById("stop-btn");
    const statusDiv = document.getElementById("status");

    startBtn.onclick = startScanning;
    stopBtn.onclick = stopScanning;

    function startScanning() {
      scanner = new Html5Qrcode("qr-reader");
      scanner
        .start(
          { facingMode: "environment" },
          { fps: 10, qrbox: { width: 250, height: 250 }, aspectRatio: 1.0 },
          onScanSuccess
        )
        .then(() => {
          isScanning = true;
          startBtn.style.display = "none";
          stopBtn.style.display = "block";
          updateStatus("scanning", "üì° Escaneando... apunta al c√≥digo QR");
        })
        .catch((err) => {
          updateStatus("error", "‚ö†Ô∏è Error al acceder a la c√°mara: " + err);
        });
    }

    function stopScanning() {
      if (scanner && isScanning) {
        scanner.stop().then(() => {
          isScanning = false;
          startBtn.style.display = "block";
          stopBtn.style.display = "none";
          updateStatus("waiting", "‚è∏Ô∏è Esc√°ner detenido.");
        });
      }
    }

    function onScanSuccess(decodedText) {
      if (!decodedText) return;

      // Validar dominio permitido
      try {
        const url = new URL(decodedText);
        if (url.hostname === ALLOWED_DOMAIN) {
          updateStatus("success", "‚úÖ C√≥digo v√°lido, redirigiendo...");
          setTimeout(() => {
            // Redirecci√≥n dentro del proyecto Framer (abre dentro del mismo iframe o pesta√±a)
            window.top.location.href = url.href;
          }, 1200);
        } else {
          updateStatus("error", "üö´ Dominio no permitido: " + url.hostname);
        }
      } catch (e) {
        updateStatus("error", "‚ùå C√≥digo no es una URL v√°lida.");
      }
    }

    function updateStatus(type, message) {
      statusDiv.className = "status " + type;
      statusDiv.textContent = message;
    }

    // Detener esc√°ner al salir
    window.addEventListener("beforeunload", () => {
      if (scanner && isScanning) scanner.stop();
    });
  </script>
</body>
</html>
